<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoldRushClick</title>
  <link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAACISURBVHgB7YyxCQAwDAOvgiNwAk7ACTgCJ+AMHIGzT8nMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzM9KPV6fSH6uePjo//+ALnWxyecXjE4RGHRxweccjF4RGHRxweccjF4RGHRxweccjF4RGHRxweccjjE4fmH2xPP1tQwF8AAAAASUVORK5CYII=">
  <style>
    body { font-family: 'Courier New', monospace; margin: 0; background-color: #fdf6e3; color: #333; }
    nav { background: #d4a017; padding: 10px; text-align: center; }
    nav a { color: white; margin: 0 15px; text-decoration: none; }
    nav a:hover { text-decoration: underline; }
    .page { display: none; text-align: center; padding: 20px; }
    .active { display: block; }
    h1 { color: #d4a017; font-size: 36px; }
    button { padding: 10px 20px; font-size: 16px; margin: 5px; background-color: #d4a017; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #b58900; }
    #gold { font-size: 48px; cursor: pointer; transition: transform 0.1s; }
    #gold:hover { transform: scale(1.1); }
    .coin-pop { position: absolute; color: #d4a017; font-size: 20px; animation: fadeUp 1s forwards; }
    @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
    #eventBanner { font-size: 20px; color: #d4a017; font-weight: bold; display: none; }
    .progress-bar { width: 200px; height: 20px; background: #ccc; margin: 10px auto; border: 1px solid #333; }
    .progress-fill { height: 100%; background: #d4a017; transition: width 0.3s; }
    #footer { margin-top: 20px; font-size: 14px; }
    #footer a { color: #d4a017; text-decoration: none; margin: 0 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 5px 0; }
    #loginPage, #instructions, #privacy, #terms { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid #d4a017; max-width: 500px; max-height: 80%; overflow-y: auto; }
    #loginPage.active { display: block; }
  </style>
</head>
<body>
  <div id="loginPage" class="page active">
    <h1>GoldRushClick Login</h1>
    <p>Email: <input id="emailInput" type="email" placeholder="example@email.com"></p>
    <p>Password: <input id="passwordInput" type="password" placeholder="Password"></p>
    <button id="loginBtn">Login</button>
    <button id="registerBtn">Register</button>
  </div>

  <nav>
    <a href="#" onclick="showPage('home')">Home</a>
    <a href="#" onclick="showPage('game')">Game</a>
    <a href="#" onclick="showPage('profile')">Profile</a>
    <a href="#" onclick="showPage('quests')">Quests</a>
    <a href="#" onclick="showPage('community')">Community</a>
    <a href="#" onclick="showPage('shop')">Shop</a>
    <a href="#" onclick="showPage('events')">Events</a>
    <a href="#" onclick="showPage('lore')">Lore</a>
  </nav>

  <div id="home" class="page">
    <h1>Welcome to GoldRushClick!</h1>
    <p>Dig for gold, complete quests, and rise to the top!</p>
    <button onclick="showPage('game')">Start Digging</button>
    <button onclick="document.getElementById('instructions').style.display='block'">How to Play</button>
  </div>

  <div id="game" class="page">
    <h1>GoldRushClick</h1>
    <p>Player: <span id="usernameDisplay">Guest</span> | Level: <span id="level">1</span></p>
    <p>Coins: <span id="coins">0</span> | XP: <span id="xp">0</span></p>
    <p id="gold">⛏️ Click for Gold!</p>
    <p id="eventBanner"></p>
    <p>Digs per second: <span id="dps">0</span> | Multiplier: <span id="multiplier">1x</span></p>
    <div class="progress-bar"><div class="progress-fill" id="xpProgress" style="width: 0%;"></div></div>
    <p>Next Level: <span id="xpNext">100</span> XP</p>
  </div>

  <div id="profile" class="page">
    <h1>Profile</h1>
    <p>Total Clicks: <span id="totalClicks">0</span> | Time Played: <span id="timePlayed">0s</span></p>
    <p>Pickaxe Skin: <span id="skin">Default</span></p>
    <button id="buyGoldenSkin">Buy Golden Skin (500 coins)</button>
    <button id="logoutBtn">Logout</button>
  </div>

  <div id="quests" class="page">
    <h1>Quests</h1>
    <ul id="questList">
      <li>Click 100 times - <button id="claimClick100">Claim (50 coins)</button></li>
      <li>Earn 500 coins - <button id="claimEarn500">Claim (100 coins)</button></li>
    </ul>
    <p>Daily Bonus: <button id="claimDaily">Claim (Day <span id="dailyDay">1</span>)</button></p>
  </div>

  <div id="community" class="page">
    <h1>Community</h1>
    <p>Leaderboard: <ul id="leaderboardList"></ul></p>
    <p>Friends: <button id="addFriend">Add Friend</button></p>
    <p>Chat: <input id="chatInput" placeholder="Say something..."><button id="sendChat">Send</button></p>
    <ul id="chatList"></ul>
  </div>

  <div id="shop" class="page">
    <h1>Shop</h1>
    <ul>
      <li><button id="buyBasicPickaxe">Basic Pickaxe (20 coins, +1 DPS)</button></li>
      <li><button id="buyGoldVault">Gold Vault (2000 coins, +100 DPS)</button></li>
      <li><button id="buyPremium">Premium Rush ($1, +200 DPS)</button></li>
    </ul>
  </div>

  <div id="events" class="page">
    <h1>Events</h1>
    <p>Current Event: <span id="eventStatus">None</span></p>
    <button id="playRockSmash">Play Rock Smash (10 coins)</button>
  </div>

  <div id="lore" class="page">
    <h1>Lore</h1>
    <p>Chapter 1: The mines were once home to a lost civilization...</p>
    <p id="loreUnlock">Unlock more by reaching Level 5!</p>
  </div>

  <div id="instructions">
    <h2>How to Play GoldRushClick</h2>
    <p>Welcome to GoldRushClick! Here’s how to get started:</p>
    <ul style="text-align: left;">
      <li><strong>Click for Gold</strong>: Click the "⛏️ Click for Gold!" text to earn coins.</li>
      <li><strong>Buy Upgrades</strong>: Spend coins in the Shop to boost your Digs per Second (DPS).</li>
      <li><strong>Premium Rush</strong>: Pay $1 for a +200 DPS boost!</li>
      <li><strong>Quests</strong>: Complete tasks like "Click 100 times" for extra coins.</li>
      <li><strong>Events</strong>: Catch "Gold Fever" (5x coins, 20s) for huge gains!</li>
      <li><strong>Level Up</strong>: Earn XP to unlock lore and more.</li>
      <li><strong>Community</strong>: Chat and check the leaderboard!</li>
    </ul>
    <button onclick="document.getElementById('instructions').style.display='none'">Close</button>
  </div>

  <div id="privacy">
    <h2>Privacy Policy</h2>
    <p>Owned by Quantbro Corp. Basics:</p>
    <ul style="text-align: left;">
      <li><strong>Data</strong>: Email, game progress, chats stored for functionality.</li>
      <li><strong>Use</strong>: Only for game and leaderboards.</li>
      <li><strong>Sharing</strong>: Only with Firebase and Stripe.</li>
      <li><strong>Cookies</strong>: Local storage only.</li>
      <li><strong>Contact</strong>: GitHub repo.</li>
    </ul>
    <p>Last updated: April 1, 2025.</p>
    <button onclick="document.getElementById('privacy').style.display='none'">Close</button>
  </div>

  <div id="terms">
    <h2>Terms of Service</h2>
    <p>Owned by Quantbro Corp. Rules:</p>
    <ul style="text-align: left;">
      <li><strong>Use</strong>: No cheating.</li>
      <li><strong>Payments</strong>: $1 Premium Rush, non-refundable.</li>
      <li><strong>Data</strong>: See Privacy Policy.</li>
      <li><strong>Changes</strong>: Terms may update.</li>
      <li><strong>Liability</strong>: Play at your own risk.</li>
    </ul>
    <p><a href="https://github.com/quantbro1/goldrushclick" target="_blank">GitHub</a>. Last updated: April 1, 2025.</p>
    <button onclick="document.getElementById('terms').style.display='none'">Close</button>
  </div>

  <div id="footer">
    <a href="#" onclick="document.getElementById('privacy').style.display='block'; return false;">Privacy Policy</a>
    <a href="#" onclick="document.getElementById('terms').style.display='block'; return false;">Terms of Service</a>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe('pk_test_51R8lPYDIy2nI1g7e4FE9TCBdq4i6ui8BTzkh2IwBlb8Mj2bNEELO19sZrRwPTacbTBzBKSEoL6aDdEr4Adk2h8tP00kuMmFyoM');
    const firebaseConfig = {
      apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
      authDomain: "goldrushclick.firebaseapp.com",
      projectId: "goldrushclick",
      storageBucket: "goldrushclick.firebasestorage.app",
      messagingSenderId: "43423974817",
      appId: "1:43423974817:web:7ed559d67001e9a739b7e0",
      measurementId: "G-YQRFZ1DZBR"
    };

    if (firebaseConfig.apiKey === "FIREBASE_API_KEY_PLACEHOLDER") {
      console.error("Firebase API key not injected. Set FIREBASE_API_KEY in Netlify env vars.");
      alert("Game won’t work—API key not set!");
    }

    firebase.initializeApp(firebaseConfig);
    console.log("Firebase initialized successfully");
    const db = firebase.firestore();
    const auth = firebase.auth();
    console.log("Auth module loaded");

    let user = null;
    let username = "Guest";
    let coins = 0, dps = 0, multiplier = 1, xp = 0, level = 1, totalClicks = 0, timePlayed = 0;
    let skin = "Default", eventActive = false, dailyDay = 1, chatMessages = [];

    auth.onAuthStateChanged(async (firebaseUser) => {
      if (firebaseUser) {
        user = firebaseUser;
        username = firebaseUser.email.split('@')[0];
        console.log("User logged in:", username);
        await loadData();
        document.getElementById("loginPage").style.display = "none";
        showPage('home');
        updateLeaderboard(); // Initial leaderboard load after login
      } else {
        user = null;
        username = "Guest";
        console.log("User logged out");
        document.getElementById("loginPage").style.display = "block";
        document.querySelectorAll('.page:not(#loginPage)').forEach(page => page.classList.remove('active'));
      }
    });

    async function login() {
      const email = document.getElementById("emailInput").value;
      const password = document.getElementById("passwordInput").value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    }

    async function register() {
      const email = document.getElementById("emailInput").value;
      const password = document.getElementById("passwordInput").value;
      console.log("Registering:", email);
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        console.log("Registered:", userCredential.user.email);
      } catch (error) {
        console.error("Registration failed:", error);
        alert("Registration failed: " + error.message);
      }
    }

    async function logout() {
      await saveData(); // Save before logout
      await auth.signOut();
      alert("Logged out!");
    }

    async function loadData() {
      if (!user) return;
      const doc = await db.collection("players").doc(user.uid).get();
      if (doc.exists) {
        const data = doc.data();
        coins = data.coins || 0;
        dps = data.digsPerSecond || 0;
        multiplier = data.multiplier || 1;
        xp = data.xp || 0;
        level = data.level || 1;
        totalClicks = data.totalClicks || 0;
        timePlayed = data.timePlayed || 0;
        skin = data.skin || "Default";
        dailyDay = data.dailyDay || 1;
        chatMessages = data.chatMessages || [];
        console.log("Data loaded for", username, ":", { coins, level });
      } else {
        await saveData();
      }
      updateDisplay();
      updateChat();
    }

    async function saveData() {
      if (!user) return;
      console.log("Saving data:", { coins, dps, multiplier, xp, level });
      await db.collection("players").doc(user.uid).set({
        coins, digsPerSecond: dps, multiplier, xp, level, totalClicks, timePlayed, skin, dailyDay, chatMessages,
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
      });
    }

    function showPage(pageId) {
      if (!user) return;
      console.log("Showing page:", pageId);
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      updateDisplay();
      if (pageId === 'community') {
        console.log("Triggering leaderboard update from showPage");
        updateLeaderboard();
      }
    }

    function dig() {
      const coinGain = (eventActive ? 5 : 1) * multiplier;
      coins += coinGain;
      xp += 1;
      totalClicks++;
      checkLevelUp();
      createCoinPop(coinGain);
      updateDisplay();
    }

    function createCoinPop(amount) {
      const gold = document.getElementById("gold");
      const pop = document.createElement("div");
      pop.className = "coin-pop";
      pop.textContent = `+${amount}`;
      pop.style.left = `${gold.offsetLeft + 20}px`;
      pop.style.top = `${gold.offsetTop - 20}px`;
      document.body.appendChild(pop);
      setTimeout(() => pop.remove(), 1000);
    }

    function buyUpgrade(cost, dpsIncrease, itemName) {
      if (coins >= cost) {
        coins -= cost;
        dps += dpsIncrease;
        updateDisplay();
        saveData();
      } else {
        alert(`Not enough coins for ${itemName}!`);
      }
    }

    function goPremium() {
      stripe.redirectToCheckout({
        lineItems: [{ price: 'price_1R8lQcDIy2nI1g7eQdl4RreS', quantity: 1 }],
        mode: 'payment',
        successUrl: window.location.href + '?premium=true',
        cancelUrl: window.location.href
      });
    }

    function buySkin() {
      const cost = 500;
      if (coins >= cost) {
        coins -= cost;
        skin = "Golden";
        updateDisplay();
        saveData();
      } else {
        alert("Not enough coins for Golden Skin!");
      }
    }

    function checkLevelUp() {
      const xpNeeded = level * 100;
      if (xp >= xpNeeded) {
        level++;
        xp -= xpNeeded;
        alert(`Level Up! You're now Level ${level}`);
        if (level >= 5) document.getElementById("loreUnlock").innerHTML = "Chapter 2: Legends speak of a golden vein...";
        saveData();
      }
    }

    function claimQuest(questId) {
      if (questId === "click100" && totalClicks >= 100) {
        coins += 50;
        alert("Quest completed! +50 coins");
      } else if (questId === "earn500" && coins >= 500) {
        coins += 100;
        alert("Quest completed! +100 coins");
      } else {
        alert("Quest not completed yet!");
        return;
      }
      updateDisplay();
      saveData();
    }

    function claimDaily() {
      const rewards = [10, 20, 50, 100, 200];
      coins += rewards[dailyDay - 1];
      alert(`Daily bonus claimed! +${rewards[dailyDay - 1]} coins`);
      dailyDay = dailyDay % 5 + 1;
      updateDisplay();
      saveData();
    }

    function playRockSmash() {
      coins += 10;
      alert("Rock Smash! +10 coins");
      updateDisplay();
      saveData();
    }

    function addFriend() {
      alert("Friend feature coming soon!");
    }

    function sendChat() {
      const message = document.getElementById("chatInput").value;
      if (message) {
        chatMessages.push(`${username}: ${message}`);
        document.getElementById("chatInput").value = "";
        updateChat();
        saveData();
      }
    }

    function updateChat() {
      const chatList = document.getElementById("chatList");
      chatList.innerHTML = "";
      chatMessages.slice(-5).forEach(msg => {
        const li = document.createElement("li");
        li.textContent = msg;
        chatList.appendChild(li);
      });
    }

    async function updateLeaderboard() {
      try {
        console.log("Fetching leaderboard data...");
        const snapshot = await db.collection("players").orderBy("coins", "desc").limit(5).get();
        console.log("Leaderboard snapshot size:", snapshot.size);
        const leaderboardList = document.getElementById("leaderboardList");
        if (!leaderboardList) {
          console.error("Leaderboard list element not found!");
          return;
        }
        leaderboardList.innerHTML = "";
        if (snapshot.empty) {
          leaderboardList.innerHTML = "<li>No players found yet!</li>";
          console.log("No leaderboard data available.");
          return;
        }
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log("Player data:", doc.id, data);
          const li = document.createElement("li");
          li.textContent = `${doc.id.split('@')[0]}: ${Math.floor(data.coins)} coins (x${(data.multiplier || 1).toFixed(1)})`;
          leaderboardList.appendChild(li);
        });
      } catch (error) {
        console.error("Leaderboard error:", error);
        const leaderboardList = document.getElementById("leaderboardList");
        if (leaderboardList) leaderboardList.innerHTML = "<li>Error loading leaderboard</li>";
      }
    }

    function startEvent() {
      if (!eventActive && Math.random() < 0.1) {
        eventActive = true;
        document.getElementById("eventBanner").textContent = "Gold Fever! 5x Coins for 20s!";
        document.getElementById("eventBanner").style.display = "block";
        document.getElementById("eventStatus").textContent = "Gold Fever (20s)";
        setTimeout(() => {
          eventActive = false;
          document.getElementById("eventBanner").style.display = "none";
          document.getElementById("eventStatus").textContent = "None";
          saveData();
        }, 20000);
      }
    }

    function updateDisplay() {
      document.getElementById("usernameDisplay").textContent = username;
      document.getElementById("coins").textContent = Math.floor(coins);
      document.getElementById("dps").textContent = dps;
      document.getElementById("multiplier").textContent = multiplier.toFixed(1) + "x";
      document.getElementById("xp").textContent = xp;
      document.getElementById("level").textContent = level;
      document.getElementById("totalClicks").textContent = totalClicks;
      document.getElementById("timePlayed").textContent = Math.floor(timePlayed / 1000) + "s";
      document.getElementById("skin").textContent = skin;
      document.getElementById("xpProgress").style.width = `${(xp / (level * 100)) * 100}%`;
      document.getElementById("xpNext").textContent = level * 100;
      document.getElementById("dailyDay").textContent = dailyDay;
    }

    // Event Listeners
    document.getElementById("loginBtn").addEventListener("click", login);
    document.getElementById("registerBtn").addEventListener("click", register);
    document.getElementById("logoutBtn").addEventListener("click", logout);
    document.getElementById("gold").addEventListener("click", dig);
    document.getElementById("buyBasicPickaxe").addEventListener("click", () => buyUpgrade(20, 1, "Basic Pickaxe"));
    document.getElementById("buyGoldVault").addEventListener("click", () => buyUpgrade(2000, 100, "Gold Vault"));
    document.getElementById("buyPremium").addEventListener("click", goPremium);
    document.getElementById("buyGoldenSkin").addEventListener("click", buySkin);
    document.getElementById("claimClick100").addEventListener("click", () => claimQuest("click100"));
    document.getElementById("claimEarn500").addEventListener("click", () => claimQuest("earn500"));
    document.getElementById("claimDaily").addEventListener("click", claimDaily);
    document.getElementById("playRockSmash").addEventListener("click", playRockSmash);
    document.getElementById("addFriend").addEventListener("click", addFriend);
    document.getElementById("sendChat").addEventListener("click", sendChat);

    // Premium Check
    if (window.location.search.includes('premium=true') && dps < 200) {
      dps += 200;
      alert("Premium Rush activated! +200 DPS");
      saveData();
    }

    // Game Loop (UI only)
    setInterval(() => {
      if (user) {
        coins += dps * multiplier;
        timePlayed += 1000;
        startEvent();
        updateDisplay();
      }
    }, 1000);

    // Periodic Save (every 60 seconds)
    setInterval(() => {
      if (user) {
        console.log("Periodic save triggered");
        saveData();
      }
    }, 60000);

    // Leaderboard Update
    setInterval(() => {
      if (user) {
        console.log("Periodic leaderboard update triggered");
        updateLeaderboard();
      }
    }, 60000);
  </script>
</body>
</html>
