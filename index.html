<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GoldRushClick</title>
  <style>
    body { font-family: 'Courier New', monospace; text-align: center; margin: 20px; background-color: #fdf6e3; color: #333; }
    h1 { color: #d4a017; font-size: 36px; }
    button { padding: 10px 20px; font-size: 16px; margin: 5px; background-color: #d4a017; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #b58900; }
    #gold { font-size: 48px; cursor: pointer; transition: transform 0.1s; }
    #gold:hover { transform: scale(1.1); }
    #ad, #shop, #achievements, #leaderboard, #stats { margin-top: 20px; }
    p { font-size: 18px; }
    h2 { font-size: 24px; color: #d4a017; }
    ul { list-style: none; padding: 0; }
    li { font-size: 16px; margin: 5px 0; }
    .coin-pop { position: absolute; color: #d4a017; font-size: 20px; animation: fadeUp 1s forwards; }
    @keyframes fadeUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }
    #eventBanner { font-size: 20px; color: #d4a017; font-weight: bold; display: none; }
    .disabled { background-color: #666; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>GoldRushClick</h1>
  <p>Player: <span id="usernameDisplay">Guest</span></p>
  <p>Coins: <span id="coins">0</span></p>
  <p id="gold">⛏️ Click for Gold!</p>
  <p id="eventBanner"></p>
  <p>Digs per second: <span id="dps">0</span> | Multiplier: <span id="multiplier">1x</span></p>

  <div id="shop">
    <h2>Shop</h2>
    <ul id="shopList">
      <li><button id="basicPickaxe">Basic Pickaxe (10 coins, +1 DPS)</button></li>
      <li><button id="ironPickaxe">Iron Pickaxe (50 coins, +2 DPS)</button></li>
      <li><button id="goldPickaxe">Gold Pickaxe (200 coins, +5 DPS)</button></li>
      <li><button id="diamondPickaxe">Diamond Pickaxe (1000 coins, +10 DPS)</button></li>
      <li><button id="autoMiner">Auto-Miner (100 coins, +1 DPS)</button></li>
      <li><button id="megaMiner">Mega-Miner (500 coins, +5 DPS)</button></li>
      <li><button id="goldVault">Gold Vault (2000 coins, +20 DPS)</button></li>
      <li><button id="premium1">Premium Rush ($1, +2 DPS)</button></li>
    </ul>
  </div>

  <div id="stats">
    <h2>Stats</h2>
    <p>Total Clicks: <span id="totalClicks">0</span> | Time Played: <span id="timePlayed">0s</span></p>
    <button id="prestigeBtn">Prestige (Reset for 1.5x Multiplier)</button>
    <p>Your Referral Code: <span id="referralCode"></span> <button id="copyReferral">Copy Code</button> | <button id="claimReferral">Claim Referral Bonus (50 coins)</button></p>
  </div>

  <div id="achievements">
    <h2>Achievements</h2>
    <ul id="achievementsList"></ul>
  </div>

  <div id="leaderboard">
    <h2>Leaderboard</h2>
    <button id="refreshLeaderboard">Refresh Leaderboard</button>
    <ul id="leaderboardList"></ul>
  </div>

  <div id="ad">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8529571438098551" crossorigin="anonymous"></script>
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-8529571438098551" data-ad-slot="YOUR_AD_SLOT_HERE"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    console.log("Script loaded!");
    const stripe = Stripe('pk_test_51R8lPYDIy2nI1g7e4FE9TCBdq4i6ui8BTzkh2IwBlb8Mj2bNEELO19sZrRwPTacbTBzBKSEoL6aDdEr4Adk2h8tP00kuMmFyoM');

    const firebaseConfig = {
      apiKey: typeof process !== 'undefined' && process.env.FIREBASE_API_KEY ? process.env.FIREBASE_API_KEY : "MISSING_API_KEY",
      authDomain: "goldrushclick.firebaseapp.com",
      projectId: "goldrushclick",
      storageBucket: "goldrushclick.firebasestorage.app",
      messagingSenderId: "43423974817",
      appId: "1:43423974817:web:7ed559d67001e9a739b7e0",
      measurementId: "G-YQRFZ1DZBR"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let username = localStorage.getItem('username');
    if (!username) {
      username = prompt("Enter your username:") || "Guest_" + Math.floor(Math.random() * 1000);
      localStorage.setItem('username', username);
    }
    document.getElementById("usernameDisplay").innerText = username;

    let coins = 0;
    let digsPerSecond = 0;
    let multiplier = 1;
    let lastSavedCoins = 0;
    let lastLeaderboardUpdate = 0;
    let achievements = [];
    let totalClicks = parseInt(localStorage.getItem('totalClicks')) || 0;
    let timePlayed = parseInt(localStorage.getItem('timePlayed')) || 0;
    let referralCode = btoa(username).slice(0, 8);
    let referralsUsed = [];
    let eventActive = false;
    let leaderboardCache = [];

    async function loadPlayerData() {
      const docRef = db.collection("players").doc(username);
      const doc = await docRef.get();
      if (doc.exists) {
        const data = doc.data();
        coins = data.coins || 0;
        digsPerSecond = data.digsPerSecond || 0;
        multiplier = data.multiplier || 1;
        achievements = data.achievements || [];
        referralsUsed = data.referralsUsed || [];
        lastSavedCoins = coins;
      } else {
        await docRef.set({ coins: 0, digsPerSecond: 0, multiplier: 1, achievements: [], referralsUsed: [] });
        lastSavedCoins = 0;
      }
      leaderboardCache = JSON.parse(localStorage.getItem('leaderboardCache')) || [];
      updateDisplay(true);
      updateAchievements();
      document.getElementById("referralCode").innerText = referralCode;
      if (!localStorage.getItem('referralExplained')) {
        alert("Share your referral code with friends! They get 50 coins when they use it, and you get 50 coins too!");
        localStorage.setItem('referralExplained', 'true');
      }
    }

    async function savePlayerData() {
      if (coins !== lastSavedCoins || achievements.length !== (await db.collection("players").doc(username).get()).data().achievements?.length) {
        await db.collection("players").doc(username).set({
          coins: coins,
          digsPerSecond: digsPerSecond,
          multiplier: multiplier,
          achievements: achievements,
          referralsUsed: referralsUsed,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        lastSavedCoins = coins;
        console.log("Saved to Firestore:", { coins, digsPerSecond, multiplier });
      }
      localStorage.setItem('totalClicks', totalClicks);
      localStorage.setItem('timePlayed', timePlayed);
    }

    function dig() {
      const coinGain = eventActive ? 2 * multiplier : multiplier;
      coins += coinGain;
      totalClicks++;
      const gold = document.getElementById("gold");
      const pop = document.createElement("div");
      pop.className = "coin-pop";
      pop.textContent = `+${coinGain}`;
      pop.style.left = `${gold.offsetLeft + 20}px`;
      pop.style.top = `${gold.offsetTop - 20}px`;
      document.body.appendChild(pop);
      setTimeout(() => pop.remove(), 1000);
      checkAchievements();
      updateDisplay(false);
    }

    function buyUpgrade(cost, dpsIncrease, itemName) {
      if (coins >= cost) {
        coins -= cost;
        digsPerSecond += dpsIncrease;
        checkAchievements();
        updateDisplay(false);
      } else {
        alert(`Not enough coins for ${itemName}! Keep digging!`);
      }
    }

    function goPremium() {
      stripe.redirectToCheckout({
        lineItems: [{ price: 'price_1R8lQcDIy2nI1g7eQdl4RreS', quantity: 1 }],
        mode: 'payment',
        successUrl: window.location.href + '?premium=true',
        cancelUrl: window.location.href,
      }).then(result => {
        if (result.error) console.error("Stripe error:", result.error.message);
      });
    }

    function prestige() {
      if (coins >= 1000) {
        coins = 0;
        digsPerSecond = 0;
        multiplier *= 1.5;
        achievements.push("Prestige Master");
        updateDisplay(true);
        savePlayerData();
        alert("Prestiged! Multiplier now " + multiplier.toFixed(1) + "x");
      } else {
        alert("Need 1000 coins to prestige!");
      }
    }

    async function claimReferral() {
      const code = prompt("Enter a referral code:");
      if (!code || code === referralCode || referralsUsed.includes(code)) {
        alert("Invalid, own, or already used code!");
        return;
      }
      const snapshot = await db.collection("players").where("username", "==", atob(code.padEnd(12, "=")).slice(0, -3)).get();
      if (!snapshot.empty) {
        const referrerDoc = snapshot.docs[0];
        const referrerData = referrerDoc.data();
        await db.collection("players").doc(referrerDoc.id).update({
          coins: (referrerData.coins || 0) + 50,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        coins += 50;
        referralsUsed.push(code);
        updateDisplay(false);
        savePlayerData();
        alert("Referral bonus claimed: +50 coins for you and your friend!");
      } else {
        alert("Code not found!");
      }
    }

    function copyReferral() {
      navigator.clipboard.writeText(referralCode).then(() => alert("Code copied: " + referralCode));
    }

    async function updateDisplay(includeLeaderboard = true) {
      document.getElementById("coins").innerText = Math.floor(coins);
      document.getElementById("dps").innerText = digsPerSecond;
      document.getElementById("multiplier").innerText = multiplier.toFixed(1) + "x";
      document.getElementById("totalClicks").innerText = totalClicks;
      document.getElementById("timePlayed").innerText = Math.floor(timePlayed / 1000) + "s";

      if (includeLeaderboard) {
        const now = Date.now();
        if (now - lastLeaderboardUpdate >= 600000 || !window.autoUpdate || !leaderboardCache.length) {
          await savePlayerData();
          const leaderboardList = document.getElementById("leaderboardList");
          leaderboardList.innerHTML = "";
          try {
            const snapshot = await db.collection("players")
              .orderBy("coins", "desc")
              .limit(5)
              .get();
            leaderboardCache = [];
            snapshot.forEach(doc => {
              const data = doc.data();
              const displayMultiplier = data.multiplier || 1;
              const entry = `${doc.id}: ${Math.floor(data.coins)} coins (x${displayMultiplier.toFixed(1)})`;
              leaderboardCache.push(entry);
              const li = document.createElement("li");
              li.textContent = entry;
              leaderboardList.appendChild(li);
            });
            localStorage.setItem('leaderboardCache', JSON.stringify(leaderboardCache));
            lastLeaderboardUpdate = now;
            console.log("Leaderboard updated from Firestore");
          } catch (error) {
            console.error("Leaderboard fetch failed:", error);
          }
        } else {
          const leaderboardList = document.getElementById("leaderboardList");
          leaderboardList.innerHTML = "";
          leaderboardCache.forEach(entry => {
            const li = document.createElement("li");
            li.textContent = entry;
            leaderboardList.appendChild(li);
          });
          console.log("Leaderboard loaded from cache");
        }
      }
    }

    function checkAchievements() {
      const newAchievements = [];
      if (coins >= 100 && !achievements.includes("100 Coins")) newAchievements.push("100 Coins");
      if (coins >= 1000 && !achievements.includes("Gold Hoarder")) newAchievements.push("Gold Hoarder");
      if (digsPerSecond >= 1 && !achievements.includes("First Upgrade")) newAchievements.push("First Upgrade");
      if (digsPerSecond >= 20 && !achievements.includes("Mining Pro")) newAchievements.push("Mining Pro");
      if (totalClicks >= 100 && !achievements.includes("Click Addict")) newAchievements.push("Click Addict");
      if (newAchievements.length) {
        achievements.push(...newAchievements);
        updateAchievements();
        savePlayerData();
      }
    }

    function updateAchievements() {
      const achievementsList = document.getElementById("achievementsList");
      achievementsList.innerHTML = "";
      achievements.forEach(ach => {
        const li = document.createElement("li");
        li.textContent = ach;
        achievementsList.appendChild(li);
      });
    }

    function startGoldRush() {
      if (!eventActive && Math.random() < 0.05) {
        eventActive = true;
        document.getElementById("eventBanner").textContent = "Gold Rush! 2x Coins for 30s!";
        document.getElementById("eventBanner").style.display = "block";
        setTimeout(() => {
          eventActive = false;
          document.getElementById("eventBanner").style.display = "none";
        }, 30000);
      }
    }

    if (window.location.search.includes('premium=true') && digsPerSecond < 2) {
      digsPerSecond = 2;
      savePlayerData();
      alert("Premium Rush activated! +2 DPS!");
    }

    document.getElementById("gold").addEventListener("click", dig);
    document.getElementById("basicPickaxe").addEventListener("click", () => buyUpgrade(10, 1, "Basic Pickaxe"));
    document.getElementById("ironPickaxe").addEventListener("click", () => buyUpgrade(50, 2, "Iron Pickaxe"));
    document.getElementById("goldPickaxe").addEventListener("click", () => buyUpgrade(200, 5, "Gold Pickaxe"));
    document.getElementById("diamondPickaxe").addEventListener("click", () => buyUpgrade(1000, 10, "Diamond Pickaxe"));
    document.getElementById("autoMiner").addEventListener("click", () => buyUpgrade(100, 1, "Auto-Miner"));
    document.getElementById("megaMiner").addEventListener("click", () => buyUpgrade(500, 5, "Mega-Miner"));
    document.getElementById("goldVault").addEventListener("click", () => buyUpgrade(2000, 20, "Gold Vault"));
    document.getElementById("premium1").addEventListener("click", goPremium);
    document.getElementById("prestigeBtn").addEventListener("click", prestige);
    document.getElementById("claimReferral").addEventListener("click", claimReferral);
    document.getElementById("copyReferral").addEventListener("click", copyReferral);
    document.getElementById("refreshLeaderboard").addEventListener("click", () => {
      window.autoUpdate = false;
      updateDisplay(true);
      window.autoUpdate = true;
    });

    setInterval(async () => {
      coins += digsPerSecond * 60 * multiplier;
      timePlayed += 60000;
      checkAchievements();
      startGoldRush();
      await savePlayerData();
      updateDisplay(false);
    }, 60000);

    setInterval(() => {
      window.autoUpdate = true;
      updateDisplay(true);
    }, 600000);

    loadPlayerData();
  </script>
</body>
</html>
